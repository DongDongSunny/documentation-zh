<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><link rel="canonical" href="https://tronprotocol.github.io/documentation-zh/developers/network/" />
      <link rel="shortcut icon" href="../../img/favicon.ico" />
    <title>网络 - Java Tron</title>
    <link rel="stylesheet" href="../../css/theme.css" />
    <link rel="stylesheet" href="../../css/theme_extra.css" />
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.5.0/styles/github.min.css" />
    
      <script>
        // Current page data
        var mkdocs_page_name = "\u7f51\u7edc";
        var mkdocs_page_input_path = "developers/network.md";
        var mkdocs_page_url = "/documentation-zh/developers/network/";
      </script>
    
    <script src="../../js/jquery-3.6.0.min.js" defer></script>
    <!--[if lt IE 9]>
      <script src="../../js/html5shiv.min.js"></script>
    <![endif]-->
      <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.5.0/highlight.min.js"></script>
      <script>hljs.initHighlightingOnLoad();</script> 
</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side stickynav">
    <div class="wy-side-scroll">
      <div class="wy-side-nav-search">
          <a href="../.." class="icon icon-home"> Java Tron
        </a><div role="search">
  <form id ="rtd-search-form" class="wy-form" action="../../search.html" method="get">
      <input type="text" name="q" placeholder="Search docs" title="Type search term here" />
  </form>
</div>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption"><span class="caption-text">入门</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../../getting_started/getting_started_with_javatron/">Java-tron入门</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">使用Java-tron</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../../using_javatron/installing_javatron/">部署Java-tron</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../using_javatron/backup_restore/">备份和恢复</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../litefullnode/">轻节点</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../using_javatron/private_network/">私链网络</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../architecture/event/">事件插件</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../architecture/database/">数据库配置</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../using_javatron/connecting_to_tron/">网络配置</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../using_javatron/metrics/">节点监控</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="#">工具</a>
    <ul>
                <li class="toctree-l2"><a class="reference internal" href="../../using_javatron/toolkit/">数据库迁移</a>
                </li>
                <li class="toctree-l2"><a class="" href="../../using_javatron/litefullnode-tool.md">轻节点工具</a>
                </li>
    </ul>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">API 接口</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../../api/http/">HTTP 接口</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../api/rpc/">gRPC 接口</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">核心协议</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../../introduction/dpos/">波场共识</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../mechanism-algorithm/sr/">超级代表</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../mechanism-algorithm/account/">账户模型</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../mechanism-algorithm/resource/">资源模型</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../contracts/contract/">智能合约</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../mechanism-algorithm/dex/">去中心化交易所</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../mechanism-algorithm/multi-signatures/">多重签名</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">Java-tron开发</span></p>
              <ul class="current">
                  <li class="toctree-l1"><a class="reference internal" href="../java-tron/">开发者指南</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../tips/">TIPs工作流程</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../issue-workflow/">Issue工作流程</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../governance/">治理流程</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../run-in-idea/">配置IDE开发环境</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../demo/">开发示例</a>
                  </li>
                  <li class="toctree-l1 current"><a class="reference internal current" href="#">核心模块</a>
    <ul class="current">
                <li class="toctree-l2"><a class="reference internal" href="../code-structure/">概述</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../chainbase/">Chainbase</a>
                </li>
                <li class="toctree-l2 current"><a class="reference internal current" href="./">网络</a>
    <ul class="current">
    <li class="toctree-l3"><a class="reference internal" href="#_2">概述</a>
        <ul>
    <li class="toctree-l4"><a class="reference internal" href="#_3">区块链网络</a>
    </li>
    <li class="toctree-l4"><a class="reference internal" href="#tron">TRON网络</a>
    </li>
        </ul>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#_4">节点发现</a>
        <ul>
    <li class="toctree-l4"><a class="reference internal" href="#kademlia">Kademlia 算法</a>
    </li>
    <li class="toctree-l4"><a class="reference internal" href="#tron_1">TRON 实现</a>
    </li>
        </ul>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#_5">节点连接</a>
        <ul>
    <li class="toctree-l4"><a class="reference internal" href="#peer">peer节点管理</a>
    </li>
    <li class="toctree-l4"><a class="reference internal" href="#tcp">建立节点间TCP连接</a>
    </li>
    <li class="toctree-l4"><a class="reference internal" href="#_8">握手</a>
    </li>
    <li class="toctree-l4"><a class="reference internal" href="#_9">信道保活</a>
    </li>
        </ul>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#_10">区块同步</a>
        <ul>
    <li class="toctree-l4"><a class="reference internal" href="#_11">链摘要及缺失区块清单</a>
    </li>
        </ul>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#_14">区块和交易广播</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#_15">总结</a>
    </li>
    </ul>
                </li>
    </ul>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">Dapp开发</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../../contracts/compiler/">Dapp开发工具</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">Wallet-cli</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../../clients/wallet-cli/">什么是Wallet-Cli</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../clients/wallet-cli-command/">Wallet命令</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">版本发布</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../../releases/upgrade-instruction/">新版本部署手册</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../releases/signature_verification/">一致性检验</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="#">历史版本</a>
    <ul>
                <li class="toctree-l2"><a class="reference internal" href="../../releases/GreatVoyage-v471/">GreatVoyage-v4.7.1</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../../releases/GreatVoyage-v470/">GreatVoyage-v4.7.0.1</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../../releases/GreatVoyage-v460/">GreatVoyage-v4.6.0</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../../releases/GreatVoyage-v452/">GreatVoyage-v4.5.2</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../../releases/GreatVoyage-v451/">GreatVoyage-v4.5.1</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../../releases/GreatVoyage-v446/">GreatVoyage-v4.4.6</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../../releases/GreatVoyage-v445/">GreatVoyage-v4.4.5</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../../releases/GreatVoyage-v444/">GreatVoyage-v4.4.4</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../../releases/GreatVoyage-v442/">GreatVoyage-v4.4.2</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../../releases/GreatVoyage-v440/">GreatVoyage-v4.4.0</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../../releases/GreatVoyage-v430/">GreatVoyage-v4.3.0</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../../releases/GreatVoyage-v4221/">GreatVoyage-v4.2.2.1</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../../releases/GreatVoyage-v422/">GreatVoyage-v4.2.2</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../../releases/GreatVoyage-v420/">GreatVoyage-v4.2.0</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../../releases/GreatVoyage-v413/">GreatVoyage-v4.1.3</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../../releases/GreatVoyage-v412/">GreatVoyage-v4.1.2</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../../releases/GreatVoyage-v411/">GreatVoyage-v4.1.1</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../../releases/GreatVoyage-v400/">GreatVoyage-v4.0.0</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../../releases/Odyssey-v37/">Odyssey-v3.7</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../../releases/Odyssey-v365/">Odyssey-v3.6.5</a>
                </li>
    </ul>
                  </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../../glossary/">术语表</a>
                </li>
              </ul>
      </div>
    </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">
      <nav class="wy-nav-top" role="navigation" aria-label="Mobile navigation menu">
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../..">Java Tron</a>
        
      </nav>
      <div class="wy-nav-content">
        <div class="rst-content"><div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="../.." class="icon icon-home" alt="Docs"></a> &raquo;</li>
          <li>Java-tron开发 &raquo;</li>
          <li>核心模块 &raquo;</li><li>网络</li>
    <li class="wy-breadcrumbs-aside">
        <a href="https://github.com/tronprotocol/documentation-zh/edit/master/docs/developers/network.md"
          class="icon icon-github"> Edit on GitHub</a>
    </li>
  </ul>
  <hr/>
</div>

          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
            <div class="section" itemprop="articleBody">
              
                <h1 id="_1">网络<a class="headerlink" href="#_1" title="Permanent link">&para;</a></h1>
<h2 id="_2">概述<a class="headerlink" href="#_2" title="Permanent link">&para;</a></h2>
<p>P2P是一种分布式网络，网络的参与者共享他们所拥有的一部分硬件资源，比如处理能力、存储能力、网络连接能力、打印机等，这些共享的资源需要由网络提供服务和内容，能被其它对等节点直接访问而无需经过中间实体。在此网络中的参与者既是服务和内容提供者，又是服务和内容获取者。</p>
<p>区别于传统的Client/Server中央服务器结构，P2P网络中的每个节点的地位都是对等的。每个节点在充当客户端的同时，也可以作为服务端给其它节点提供服务，极大地提高了资源的利用率。</p>
<h3 id="_3">区块链网络<a class="headerlink" href="#_3" title="Permanent link">&para;</a></h3>
<p>P2P 是区块链结构中的网络层，网络层的主要目的是实现区块链网络中节点之间的信息传播、验证和交流。区块链网络本质上是一个P2P网络，每个节点既能接受信息也能产生信息。节点之间通过维护一个共同的区块链数据来保持通信。</p>
<p>P2P网络作为区块链的基础，为区块链带来如下优点：</p>
<ul>
<li>防止单点攻击</li>
<li>高容错性</li>
<li>较好的兼容性与可扩展性</li>
</ul>
<h3 id="tron">TRON网络<a class="headerlink" href="#tron" title="Permanent link">&para;</a></h3>
<p>TRON架构图如下：
<img alt="image" src="https://raw.githubusercontent.com/tronprotocol/documentation-zh/master/images/network_architecture.png" /></p>
<p>P2P网络作为TRON的最底层模块，直接决定了整个区块链网络的稳定性。网络模块按照功能可以划分成以下四部分：</p>
<ul>
<li><a href="#_4">节点发现</a></li>
<li><a href="#_5">节点连接</a></li>
<li><a href="#_10">区块同步</a></li>
<li><a href="#_14">区块和交易广播</a></li>
</ul>
<p>下面将分别介绍这四个功能部分。</p>
<h2 id="_4">节点发现<a class="headerlink" href="#_4" title="Permanent link">&para;</a></h2>
<p>节点发现是区块链节点接入区块链网络的第一步。区块链网络是一种结构化的P2P网络。结构化网络会将所有节点按照某种结构有序的组织起来，比如形成一个环状网络或者树状的网络。 结构化网络普遍基于DHT(Distributed Hash Table，分布式哈希表) 算法实现。具体的实现方案有 Chord、Pastry、CAN、Kademlia 等算法。TRON 网络采用 Kademlia 算法。</p>
<h3 id="kademlia">Kademlia 算法<a class="headerlink" href="#kademlia" title="Permanent link">&para;</a></h3>
<p>Kademlia 是分布式散列表(DHT，Distributed Hash Table)的一种实现，是去中心化 P2P 网络中最核心的一种路由寻址技术，可以在无中心服务器的情况下，在网络中快速找到目标节点。</p>
<p>关于算法的详细介绍请参考 <a href="https://zh.m.wikipedia.org/zh-hans/Kademlia">Kademlia</a>。</p>
<h3 id="tron_1">TRON 实现<a class="headerlink" href="#tron_1" title="Permanent link">&para;</a></h3>
<p>TRON 实现的 Kademlia 算法，要点如下：</p>
<ul>
<li>节点ID：随机产生的512bit ID</li>
<li>节点距离：节点距离通过两个节点的ID异或运算得到，公式为：<code>节点距离 = 256 - 节点ID异或结果的前导0的个数</code>，如果计算结果为负数，距离等于0。</li>
<li>k桶：即节点路由表。根据节点距离的远近，将远端节点划分到不同的桶中，与本节点距离相同的远端节点被记录在相同的桶中，每个桶最多容纳16个节点。根据节点距离的计算公式就可以看出，TRON 实现的 Kademlia 算法一共维护256个桶。</li>
</ul>
<p>TRON 节点发现协议包括以下四种UDP消息：</p>
<ul>
<li><code>DISCOVER_PING</code> - 用于探测⼀个节点是否在线</li>
<li><code>DISCOVER_PONG</code> - 用于响应 <code>DISCOVER_PING</code> 消息</li>
<li><code>DISCOVER_FIND_NODE</code> - 用于查找与⽬标节点距离最近的其它节点</li>
<li><code>DISCOVER_NEIGHBORS</code> - 用于响应 <code>DISCOVER_FIND_NODE</code> 消息，会返回一个或者多个节点，最多16个</li>
</ul>
<h4 id="k">初始化K桶<a class="headerlink" href="#k" title="Permanent link">&para;</a></h4>
<p>节点启动后，会读取节点配置文件中配置的种子节点，以及数据库中记录的对等节点，然后向它们发送 <code>DISCOVER_PING</code> 消息，如果收到回复 <code>DISCOVER_PONG</code> ，在K桶没满的情况下，将相应节点写入K桶；如果相应桶已经达到了16个节点，则向桶中最早的节点发起挑战，挑战成功，将被挑战节点删除，将挑战节点加入K桶。K桶初始化完成后，进行节点发现流程。
<img alt="image" src="https://raw.githubusercontent.com/tronprotocol/documentation-zh/master/images/network_discoverinit.png" /></p>
<h4 id="discover_find_node">发送DISCOVER_FIND_NODE消息，发现更多节点<a class="headerlink" href="#discover_find_node" title="Permanent link">&para;</a></h4>
<p>节点发现服务会开启两个节点发现定时任务（<code>DiscoverTask</code>和<code>RefreshTask</code>），周期执行节点发现过程来更新k桶。</p>
<ul>
<li>
<p><code>DiscoverTask</code> 是发现更多距离自己近的节点，每30s执行一次，执行流程如下图所示:
    <img alt="image" src="https://raw.githubusercontent.com/tronprotocol/documentation-zh/master/images/network_discovertask.png" /></p>
</li>
<li>
<p><code>RefreshTask</code> 是通过随机节点ID来扩充本地k桶，即发现距离随机节点ID更近的节点，每7.2s执行一次，执行流程如下图所示:
    <img alt="image" src="https://raw.githubusercontent.com/tronprotocol/documentation-zh/master/images/network_refreshtask.png" /></p>
</li>
</ul>
<p><code>DiscoverTask</code>和<code>RefreshTask</code>中使用的节点发现算法，在一次调用中会执行8轮，每轮向K桶中距离目标节点 ID 最近的3个节点发送 <code>DISCOVER_FIND_NODE</code> 消息，并等待回复。</p>
<h4 id="neighborsk">接收到neighbors消息，更新K桶<a class="headerlink" href="#neighborsk" title="Permanent link">&para;</a></h4>
<p>当本节点接收到远端节点回复的 <code>DISCOVER_NEIGHBORS</code> 消息后，会依次向收到的邻居节点发送 <code>DISCOVER_PING</code> 消息，接下来如果收到了回复消息<code>DISCOVER_PONG</code>，则判断相应的K桶是否装满，如果K桶未满，则将新节点加入K桶，如果K桶满了，则向其中的某个节点发起挑战，若挑战成功(向被挑战的节点发送<code>DISCOVER_PING</code> 消息，如果未能收到其回复<code>DISCOVER_PONG</code>，则为挑战成功，否则挑战失败)，则将旧节点从K桶中删除，将新节点加入K桶。
<img alt="image" src="https://raw.githubusercontent.com/tronprotocol/documentation-zh/master/images/network_updatek.png" /></p>
<p>节点周期的执行节点发现任务，不断的更新K桶，构建自己的节点路由表。接下来就是节点间建立连接的过程了。</p>
<h2 id="_5">节点连接<a class="headerlink" href="#_5" title="Permanent link">&para;</a></h2>
<p>在了解节点间如何建立TCP连接之前，您需要首先了解peer节点类型。</p>
<h3 id="peer">peer节点管理<a class="headerlink" href="#peer" title="Permanent link">&para;</a></h3>
<p>节点需要对peer节点进行管理分类，以进行高效稳定的节点连接。远端节点可以分为如下几类：</p>
<ul>
<li>Active nodes：通过配置文件指定，系统启动后，会主动与其建立连接的节点。如果连接建立失败，则在每个TCP连接定时任务中都会重新尝试与其建立连接。</li>
<li>Passive nodes：通过配置文件指定，被动接受连接的节点。</li>
<li>Trust nodes：通过配置文件指定，Active nodes和Passive nodes都是trust nodes。当收到trust node的连接请求时，会跳过其它的条件检查，直接接受请求。</li>
<li>badNodes：当收到异常的协议报文时，会将节点加入到badNodes，生效时长1个小时，当收到 badNodes 的连接请求，会直接拒绝请求</li>
<li>recentlyDisconnectedNodes：当断开某条连接后，会把节点加入到recentlyDisconnectedNodes，有效时长30s，当收到 recentlyDisconnectedNodes 的连接请求，会直接拒绝请求</li>
</ul>
<h3 id="tcp">建立节点间TCP连接<a class="headerlink" href="#tcp" title="Permanent link">&para;</a></h3>
<p>在节点启动后，会创建一个建立节点间TCP连接的定时任务<code>poolLoopExecutor</code>，用于选择节点，并与之建立连接。建立TCP连接定时任务，工作过程如下：
<img alt="image" src="https://raw.githubusercontent.com/tronprotocol/documentation-zh/master/images/network_connect.png" /></p>
<p>TCP连接主要分为两步：首先，确定要与之建立连接的节点的列表；列表中需要包含active nodes中还没有成功建立连接的节点，然后计算还需要建立连接的数量，从邻居发现节点列表里面根据 <a href="#_6">节点过滤策略</a> 过滤出满足要求的节点，再根据 <a href="#_7">节点打分策略</a> 对节点打分排序，将最高的相应数量的节点加入到请求列表中。最后，与请求列表中的节点建立TCP连接。</p>
<h4 id="_6">节点过滤策略<a class="headerlink" href="#_6" title="Permanent link">&para;</a></h4>
<p>建立节点连接时，需过滤掉如下几类节点，并判断节点自己的连接数是否达到了最大连接。</p>
<ul>
<li>自身节点</li>
<li>recentlyDisconnectedNodes列表中的节点</li>
<li>badNodes列表中的节点</li>
<li>已经建立了连接的节点</li>
<li>与该节点ip建立的连接数已经达到了上限值maxConnectionsWithSameIp的节点</li>
</ul>
<p>但是对于可信节点，会忽略掉部分过滤策略，始终与其建立连接。
<img alt="image" src="https://raw.githubusercontent.com/tronprotocol/documentation-zh/master/images/network_filterrule.png" /></p>
<h4 id="_7">节点打分策略<a class="headerlink" href="#_7" title="Permanent link">&para;</a></h4>
<p>节点分数用于确定建立连接的优先级，分数越高，优先级越高。打分维度包括：</p>
<ul>
<li>丢包率：丢包率越低，说明数据通信质量越好。分数与丢包率成反比，最高分为100，最低为0</li>
<li>网络延迟：网络延时越小，说明网络质量越好。分数与平均网络延时成反比，最高分为20，最低为0</li>
<li>TCP流量：TCP流量越大，说明通信比较活跃。分数与TCP流量成正比，最高分为20，最低为0</li>
<li>断开连接次数：断开连接次数越少，说明节点越稳定。断开连接分数为负数，且与断开连接次数为正比，值为断开连接次数的10倍</li>
<li>Handshake：曾经handshake成功过的节点，表示有相同的区块链信息，因此优先选择和他们建立连接。Handshake成功次数大于0时，Handshake得分为20，否则得分为0</li>
<li>处罚状态：处于处罚状态的节点，分数为0，不参与其它维度打分，包含以下几种情况：<ul>
<li>节点断开连接时间不到60s</li>
<li>节点在badNodes列表中</li>
<li>区块链信息不一致</li>
</ul>
</li>
</ul>
<p>计算节点分数时，首先判断节点是否为处罚状态，如果是，则分数计为0，否则，节点分数为各个维度的得分之和。</p>
<h3 id="_8">握手<a class="headerlink" href="#_8" title="Permanent link">&para;</a></h3>
<p>TCP 连接建立成功后，主动发起TCP连接请求的节点，会向邻居节点发送握手消息 <code>P2P_HELLO</code>，目的为了确认节点间的链路信息是否一致，以及是否需要发起区块同步流程。</p>
<p>当邻居节点收到 <code>P2P_HELLO</code> 后，会与本地信息做比较，比如检查p2p version、创世块信息是否一致，若一致，还需要检查固化快，以及判断是否是重复的连接、恶意节点等。若所有的检查条件都通过，则会回复<code>P2P_HELLO</code>消息，然后进行区块同步或广播；否则，断开连接。</p>
<h3 id="_9">信道保活<a class="headerlink" href="#_9" title="Permanent link">&para;</a></h3>
<p>信道保活是通过 <code>P2P_PING</code>、<code>P2P_PONG</code> TCP报文来完成的。当节点与邻居节点建立了TCP连接并握手成功后，节点会为连接开启一个线程 <code>pingTask</code> 定期发送 <code>P2P_PING</code> 消息以维护该TCP连接，每10s调度一次。如果在超时时间内未收到节点回复的 <code>P2P_PONG</code> 消息，则断开连接。</p>
<h2 id="_10">区块同步<a class="headerlink" href="#_10" title="Permanent link">&para;</a></h2>
<p>在与对方节点完成握手后，如果发现对方节点的区块链比本地的区块链要长，根据最长链原则，会触发区块同步的处理流程<code>syncService.startSync</code>。同步过程中的报文交互如下图：</p>
<p><img alt="image" src="https://raw.githubusercontent.com/tronprotocol/documentation-zh/master/images/network_syncflow.png" /></p>
<p>节点A向对方节点B发送 <code>SYNC_BLOCK_CHAIN</code> 消息，以宣告本地链的摘要信息。对方节点B收到后，计算出节点A缺失的区块清单，并将缺失区块的id列表通过 <code>BLOCK_CHAIN_INVENTORY</code> 消息发送给节点A，一次最多携带2000个区块id。</p>
<p>节点A收到 <code>BLOCK_CHAIN_INVENTORY</code> 消息后，取出缺失区块id，并通过异步的方式向节点B发送 <code>FETCH_INV_DATA</code> 消息以请求缺少的区块，一次最多请求100个区块。如果还有需要同步的区块（即 <code>BLOCK_CHAIN_INVENTORY</code> 报文中的remain_num大于0），会触发新一轮的区块同步流程。</p>
<p>节点B收到节点A的 <code>FETCH_INV_DATA</code> 报文后，通过 <code>BLOCK</code> 消息将区块发送给节点A。节点A收到 <code>BLOCK</code> 报文后，异步处理该区块。</p>
<h3 id="_11">链摘要及缺失区块清单<a class="headerlink" href="#_11" title="Permanent link">&para;</a></h3>
<p>下面根据几个不同的区块同步场景示例，说明链摘要和节点缺少的区块清单的生成。</p>
<ul>
<li>链摘要：有序的区块blockID列表，包括：最高固化块、最高非固化块，以及之间二分法对应的区块</li>
<li>缺失区块清单：邻居节点根据链摘要与自己链进行比较，确定对方缺失的区块清单，返回一组连续的区块blockID以及剩余的块数</li>
</ul>
<h4 id="_12">普通场景<a class="headerlink" href="#_12" title="Permanent link">&para;</a></h4>
<p>本地头块高度为1018，固化块高度为1000，两个节点刚建立连接，所以共同块高度为0，通过二分方式获取到节点A的本地链摘要为：1000、1010、1015、1017、1018。</p>
<p>节点B收到节点A的链摘要后，结合本地链可以生产节点A缺少的区块清单为：1018、1019、1020、1021。之后节点A根据缺失区块清单，请求同步区块1019、1020、1021。
<img alt="image" src="https://raw.githubusercontent.com/tronprotocol/documentation-zh/master/images/network_sync1.png" /></p>
<h4 id="_13">切链场景<a class="headerlink" href="#_13" title="Permanent link">&para;</a></h4>
<p>本地主链头块高度为1018，固化块高度为1000，两个节点刚建立连接，所以共同块高度为0，通过二分方式获取到节点A的本地链摘要为：1000、1010、1015、1017、1018。</p>
<p>节点B收到节点A的链摘要后，发现本地主链跟节点A的主链不在同一条链上，对比节点A的链摘要，找到共同块高度为1015，则认为节点A缺少的区块清单为：1015、1016'、1017'、1018'，1019'。之后节点A根据缺失区块清单，请求同步区块1018'，1019'。
<img alt="image" src="https://raw.githubusercontent.com/tronprotocol/documentation-zh/master/images/network_sync2.png" /></p>
<p>另一种切链场景，本地主链头块高度为1018，固化块高度为1000，共同块为1017‘，位于fork链上，通过二分方式获取到节点A的本地链摘要为：1000、1009、1014、1016'、1017'。</p>
<p>节点B收到节点A的链摘要后，结合本地链可以生产节点A缺少的区块清单为：1017'、1018'、1019'。之后节点A根据缺失区块清单，请求同步区块1018'，1019'。
<img alt="image" src="https://raw.githubusercontent.com/tronprotocol/documentation-zh/master/images/network_sync3.png" /></p>
<h2 id="_14">区块和交易广播<a class="headerlink" href="#_14" title="Permanent link">&para;</a></h2>
<p>当超级代表节点生产出新的区块，或者全节点接收到用户发起的新交易时，会发起交易&amp;区块广播流程。当节点接收到新区块或者新交易时，会转发相应的区块或交易，转发与广播的流程一样。报文交互如下图所示：
<img alt="image" src="https://raw.githubusercontent.com/tronprotocol/documentation-zh/master/images/network_broadcastflow.png" /></p>
<p>其中涉及到的消息类型包括：</p>
<ul>
<li><code>INVENTORY</code> - 广播清单：区块或者交易id列表</li>
<li><code>FETCH_INV_DATA</code> - 请求需要获取的清单数据：区块或者交易id列表</li>
<li><code>BLOCK</code> - 区块数据 </li>
<li><code>TRXS</code> - 交易数据</li>
</ul>
<p>节点A将待广播交易或区块通过 <code>INVENTORY</code> 清单消息发送到节点B。节点B收到 <code>INVENTORY</code> 清单消息后，需要检查对方节点的状态，如果可以接收该消息，则将清单中的区块/交易放入待获取队列 <code>invToFetch</code> 中。如果是区块清单，还会立即触发"获取区块&amp;交易任务"，来向节点A发送 <code>FETCH_INV_DATA</code> 消息获取区块&amp;交易。</p>
<p>节点A收到 <code>FETCH_INV_DATA</code> 消息后，会检查是否发送过清单消息给对方，如果发送过，则根据清单数据，向节点B发送交易或者区块消息。节点B收到交易或者区块消息后，处理消息，并触发转发流程。</p>
<h2 id="_15">总结<a class="headerlink" href="#_15" title="Permanent link">&para;</a></h2>
<p>本文介绍了TRON最底层模块-P2P网络相关的实现细节，包括节点发现、节点连接、区块同步、区块和交易广播流程，希望通过阅读本文能帮助开发者进一步了解和开发java-tron网络相关模块。</p>
              
            </div>
          </div><footer>
    <div class="rst-footer-buttons" role="navigation" aria-label="Footer Navigation">
        <a href="../chainbase/" class="btn btn-neutral float-left" title="Chainbase"><span class="icon icon-circle-arrow-left"></span> Previous</a>
        <a href="../../contracts/compiler/" class="btn btn-neutral float-right" title="Dapp开发工具">Next <span class="icon icon-circle-arrow-right"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <!-- Copyright etc -->
  </div>

  Built with <a href="https://www.mkdocs.org/">MkDocs</a> using a <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>.
</footer>
          
        </div>
      </div>

    </section>

  </div>

  <div class="rst-versions" role="note" aria-label="Versions">
  <span class="rst-current-version" data-toggle="rst-current-version">
    
        <span>
          <a href="https://github.com/tronprotocol/documentation-zh" class="fa fa-github" style="color: #fcfcfc"> GitHub</a>
        </span>
    
    
      <span><a href="../chainbase/" style="color: #fcfcfc">&laquo; Previous</a></span>
    
    
      <span><a href="../../contracts/compiler/" style="color: #fcfcfc">Next &raquo;</a></span>
    
  </span>
</div>
    <script>var base_url = '../..';</script>
    <script src="../../js/theme_extra.js" defer></script>
    <script src="../../js/theme.js" defer></script>
      <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.0/MathJax.js?config=TeX-MML-AM_CHTML" defer></script>
      <script src="../../search/main.js" defer></script>
    <script defer>
        window.onload = function () {
            SphinxRtdTheme.Navigation.enable(true);
        };
    </script>

</body>
</html>
